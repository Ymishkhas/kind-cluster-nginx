apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels: { app: nginx }
spec:
  replicas: {{ .Values.replicas }}
  selector: { matchLabels: { app: nginx } }
  template:
    metadata: { labels: { app: nginx } }
    spec:
      {{- if .Values.preview.database.enabled }}
      # Init container waits for postgres to be ready
      initContainers:
      - name: wait-for-postgres
        image: postgres:18-alpine
        command:
          - sh
          - -c
          - |
            echo "Waiting for PostgreSQL to be ready..."
            until pg_isready -h {{ .Release.Name }}-preview-postgres -p 5432 -U {{ .Values.preview-postgres.auth.username }}; do
              echo "PostgreSQL is unavailable - sleeping"
              sleep 2
            done
            echo "PostgreSQL is up - testing connection..."
            PGPASSWORD={{ .Values.preview-postgres.auth.password }} psql -h {{ .Release.Name }}-preview-postgres -U {{ .Values.preview-postgres.auth.username }} -d {{ .Values.preview-postgres.auth.database }} -c "SELECT 1;"
            echo "âœ“ Connection successful!"
      {{- end }}
      
      containers:
      - name: nginx
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        ports: [{ containerPort: {{ .Values.ports.http }} }]
        
        {{- if .Values.preview.database.enabled }}
        # Inject DATABASE_URL as environment variable
        envFrom:
        - secretRef:
            name: {{ .Release.Name }}-db-connection
        
        # Also inject as command so we can log it for verification
        command: ["/bin/sh"]
        args:
          - -c
          - |
            echo "=== DATABASE CONNECTION INFO ==="
            echo "DATABASE_URL: $DATABASE_URL"
            echo "==============================="
            nginx -g 'daemon off;'
        {{- end }}
        
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        {{- if .Values.preview.database.enabled }}
        - name: nginx-index
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
        {{- end }}
      
      - name: nginx-exporter
        image: nginx/nginx-prometheus-exporter:0.10.0
        args: ["-nginx.scrape-uri=http://127.0.0.1:{{ .Values.ports.http }}/stub_status"]
        ports: [{ containerPort: {{ .Values.ports.metrics }} }]
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      {{- if .Values.preview.database.enabled }}
      - name: nginx-index
        configMap:
          name: nginx-index-html
      {{- end }}