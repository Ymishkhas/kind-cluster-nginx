n8n:
  # imagePullSecrets:
  #   - name: docker-auth

  image:
    repository: n8nio/n8n
    pullPolicy: IfNotPresent
    tag: "" # Uses chart appVersion
  imagePullSecrets: []

  ingress:
    enabled: false

  main:
    # config and secret will be shared between main/worker/webhook. No need to duplicate.
    config:
      executions_mode: "queue"
      executions_process: "main"
      webhook_url: http://n8n.localhost
      db:
        type: "postgresdb" # configuration in secrets
      n8n:
        host: "n8n.localhost"
        port: 5678
        templates_enabled: "true"
        editor_base_url: "http://n8n.localhost"
        secure_cookie: "false" # For testing
        ai_assistant_base_url: "https://api.aixlabs.com/v1/assistants/n8n"
        # metrics: "true"
        email_mode: "smtp" # configuration in secrets
        enforce_settings_file_permissions: "true"
        git_node_disable_bare_repos: "true"
        block_env_access_in_node: "false"
        log_level: "info"
        log_output: "console"
        metrics: "true"
      queue:
        health_check:
            active: true
            port: 5678
        bull:
          redis:
            host: n8n-valkey-primary
            port: 6379
            db: 0
            # username: ""
            # password: ""
      generic:
        timezone: Asia/Riyadh

    # secrets in secrets.yaml
    # secret: {}

    # Check: https://docs.n8n.io/hosting/configuration/environment-variables/ for all values.
    extraEnv:
      OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS:
        value: "true"
      # N8N_DISABLE_PRODUCTION_MAIN_PROCESS:
      #   value: "true"
      # N8N_METRICS:
      #   value: "true"
      N8N_PROXY_HOPS:
        value: "1"


    persistence:
      enabled: false
      type: dynamic
      # storageClass: "gp3"
      size: 5Gi
      accessModes:
        - ReadWriteOnce

    extraVolumes: []
    extraVolumeMounts: []

    # Number of desired pods. More than one pod is supported in n8n enterprise.
    replicaCount: 1

    deploymentStrategy:
      type: RollingUpdate
      maxSurge: 1
      maxUnavailable: 0

    serviceAccount:
      create: true
      annotations: {}
      name: ""

    deploymentAnnotations: {}
    deploymentLabels: {}
    podAnnotations: {}
    podLabels:
      cost-center: n8n
      sub-unit: main
      retention: low

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    securityContext: {}
    # capabilities:
    #   drop:
    #   - ALL
    # readOnlyRootFilesystem: true
    #  runAsNonRoot: true
    #  runAsUser: 1000

    # here you can specify lifecycle hooks - it can be used e.g., to easily add packages to the container without building
    # your own docker image
    # see https://github.com/8gears/n8n-helm-chart/pull/30
    lifecycle: {}

    #  here's the sample configuration to add mysql-client to the container
    # lifecycle:
    #  postStart:
    #    exec:
    #      command: ["/bin/sh", "-c", "apk add mysql-client"]

    # here you can override a command for main container
    # it may be used to override a starting script (e.g., to resolve issues like https://github.com/n8n-io/n8n/issues/6412) or run additional preparation steps (e.g., installing additional software)
    command: []

    # sample configuration that overrides starting script and solves above issue (also it runs n8n as root, so be careful):
    # command:
    #  - tini
    #  - --
    #  - /bin/sh
    #  - -c
    #  - chmod o+rx /root; chown -R node /root/.n8n || true; chown -R node /root/.n8n; ln -s /root/.n8n /home/node; chown -R node /home/node || true; node /usr/local/bin/n8n

    livenessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
      successThreshold: 1

    readinessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1

    # List of initialization containers belonging to the pod. Init containers are executed in order prior to containers being started.
    # See https://kubernetes.io/docs/concepts/workloads/pods/init-containers/
    initContainers: []
    #    - name: init-data-dir
    #      image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
    #      command: [ "/bin/sh", "-c", "mkdir -p /home/node/.n8n/" ]
    #      volumeMounts:
    #        - name: data
    #          mountPath: /home/node/.n8n

    service:
      enabled: true
      annotations: {}
      type: ClusterIP
      port: 80

    resources:
      requests:
        cpu: 300m
        memory: 300Mi
      limits:
        memory: 700Mi

    autoscaling:
      enabled: false

    nodeSelector: {}
    tolerations: []
    affinity: {}
    # affinity:
    #   nodeAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       nodeSelectorTerms:
    #       - matchExpressions:
    #         - key: role
    #           operator: In
    #           values:
    #             - critical

    # Pod termination grace period in seconds
    terminationGracePeriodSeconds: 30

  # # # # # # # # # # # # # # # #
  #
  # Worker related settings
  #
  worker:
    enabled: true

    # additional (to main) config for worker
    config: {}
    secret: {}
    extraEnv: {}
    # extraEnv:
    #   N8N_DISABLE_PRODUCTION_MAIN_PROCESS:
    #     value: "true"


    concurrency: 10

    persistence:
      enabled: false
      type: emptyDir
      # storageClass: "gp3"
      # size: 3Gi

    replicaCount: 1

    deploymentStrategy:
      type: RollingUpdate
      maxSurge: "50%"
      maxUnavailable: "50%"

    serviceAccount:
      create: true
      annotations: {}
      name: ""

    deploymentAnnotations: {}
    deploymentLabels: {}
    podAnnotations: {}
    podLabels:
      cost-center: n8n
      sub-unit: worker
      retention: low

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    securityContext: {}
    # capabilities:
    #   drop:
    #   - ALL
    # readOnlyRootFilesystem: true
    #  runAsNonRoot: true
    #  runAsUser: 1000


    lifecycle: {}
    command: []
    commandArgs: []
    initContainers: []

    service:
      type: ClusterIP
      port: 80

    resources:
      requests:
        cpu: 300m
        memory: 650Mi
      limits:
        memory: 1000Mi

    autoscaling:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 80
      targetMemoryUtilizationPercentage: 80

    nodeSelector: {}
    tolerations: []
    affinity: {}
    # affinity:
    #   nodeAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       nodeSelectorTerms:
    #       - matchExpressions:
    #         - key: role
    #           operator: In
    #           values:
    #             - critical

    # Pod termination grace period in seconds
    terminationGracePeriodSeconds: 30

  # Webhook related settings
  webhook:
    enabled: true
    # additional (to main) config for webhook
    config: {}
    secret: {}
    extraEnv:
      OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS:
        value: "true"
      N8N_PROXY_HOPS:
        value: "1"

    persistence:
      enabled: false
      type: emptyDir
      # storageClass: "gp3"
      # size: 3Gi

    replicaCount: 1

    deploymentStrategy:
      type: RollingUpdate
      maxSurge: "50%"
      maxUnavailable: "50%"

    nameOverride: ""
    fullnameOverride: ""

    serviceAccount:
      create: true
      annotations: {}
      name: ""

    deploymentAnnotations: {}
    deploymentLabels: {}
    podAnnotations: {}
    podLabels:
      cost-center: n8n
      sub-unit: webhook
      retention: low

    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000

    securityContext: {}
    lifecycle: {}
    command: []
    commandArgs: []
    livenessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 60
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3
      successThreshold: 1

    readinessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1

    service:
      type: ClusterIP
      port: 80

    resources:
      requests:
        cpu: 100m
        memory: 200Mi
      limits:
        memory: 500Mi

    autoscaling:
      enabled: false
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 80
      # targetMemoryUtilizationPercentage: 80
    nodeSelector: {}
    tolerations: []
    affinity: {}
    # affinity:
    #   nodeAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       nodeSelectorTerms:
    #       - matchExpressions:
    #         - key: role
    #           operator: In
    #           values:
    #             - critical

    # Pod termination grace period in seconds
    terminationGracePeriodSeconds: 30

  # Bitnami Valkey configuration
  # https://artifacthub.io/packages/helm/bitnami/valkey
  valkey:
    enabled: false
    # replicaCount: 1
    # auth:
    #   enabled: false
    # persistence:
    #   enabled: true
    #   # storageClass: gp3
    #   size: 5Gi
    # resources:
    #   requests:
    #     memory: 256Mi
    #     cpu: 100m
    #   limits:
    #     memory: 512Mi
    #     cpu: 500m
    # metrics:
    #   enabled: true
    #   serviceMonitor:
    #     enabled: true
    #     namespace: n8n
    #     labels:
    #       release: monitoring

  extraTemplateManifests: []
  extraManifests:
    # VirtualService for Istio
    - apiVersion: networking.istio.io/v1
      kind: VirtualService
      metadata:
        name: n8n
        namespace: n8n
      spec:
        gateways:
        - istio-system/main-gw
        hosts:
        - n8n.localhost
        http:
        # Webhook routes
        - match:
          - uri:
              prefix: /webhook/
          route:
          - destination:
              host: n8n-webhook.n8n.svc.cluster.local
              port:
                number: 80
        # - match:
        #   - uri:
        #       prefix: /webhook-test/
        #   route:
        #   - destination:
        #       host: n8n-webhook.n8n.svc.cluster.local
        #       port:
        #         number: 80
        - match:
          - uri:
              prefix: /
          route:
          - destination:
              host: n8n.n8n.svc.cluster.local # service-name.namespace.svc.cluster.local
              port:
                number: 80
    # ServiceMonitor for Prometheus - Main
    - apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: n8n-main-metrics
        namespace: n8n
        labels:
          release: monitoring
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: n8n
            app.kubernetes.io/component: main
        endpoints:
        - port: http
          path: /metrics
          interval: 30s
          scrapeTimeout: 10s
    # ServiceMonitor for Prometheus - Worker
    - apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: n8n-worker-metrics
        namespace: n8n
        labels:
          release: monitoring
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: n8n
            app.kubernetes.io/component: worker
        endpoints:
        - port: http
          path: /metrics
          interval: 30s
          scrapeTimeout: 10s
    # ServiceMonitor for Prometheus - Webhook
    # - apiVersion: monitoring.coreos.com/v1
    #   kind: ServiceMonitor
    #   metadata:
    #     name: n8n-webhook-metrics
    #     namespace: n8n
    #     labels:
    #       release: monitoring
    #   spec:
    #     selector:
    #       matchLabels:
    #         app.kubernetes.io/name: n8n
    #         app.kubernetes.io/component: webhook
    #     endpoints:
    #     - port: http
    #       path: /metrics
    #       interval: 30s
    #       scrapeTimeout: 10s


valkey:
  enabled: true
  architecture: standalone
  image:
    registry: registry-1.docker.io
    repository: bitnami/valkey
    # pullSecrets:
    #     - docker-auth
  auth:
    enabled: false
  primary:
    podLabels:
      retention: low
      cost-center: n8n
      sub-unit: n8n-valkey-primary
    persistence:
      enabled: true
      # storageClass: gp3
      size: 5Gi
      accessModes:
        - ReadWriteOnce
    # affinity:
    #   nodeAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       nodeSelectorTerms:
    #       - matchExpressions:
    #         - key: role
    #           operator: In
    #           values:
    #             - critical
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: n8n
      labels:
        release: monitoring